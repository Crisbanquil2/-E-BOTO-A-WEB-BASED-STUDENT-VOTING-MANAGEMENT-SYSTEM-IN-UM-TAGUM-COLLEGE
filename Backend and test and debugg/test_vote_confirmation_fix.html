<!DOCTYPE html>
<html>
<head>
    <title>Test Vote Confirmation Fix</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }

		/* Home-style navbar */
		.topbar { position:sticky; top:0; z-index:10; background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); border-bottom: 3px solid rgba(255,255,255,0.1); backdrop-filter: saturate(180%) blur(6px); box-shadow: 0 4px 20px rgba(0,0,0,0.15);} 
		.nav { max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:24px; padding:18px 24px; position: relative; padding-left: 220px; }
		.navbar-logo { position:absolute; left:20px; top:50%; transform: translateY(-50%); display:flex; align-items:center; gap:10px; }
		.navbar-logo-img { width:46px !important; height:46px !important; object-fit:contain; border-radius:50%; background:#fff; padding:2px; }
		.brand-title { color:#fff; font-weight:800; letter-spacing:.5px; font-size:18px; text-transform:uppercase; }
		.menu { list-style:none; padding:0; margin:0; display:flex; gap:60px; background:transparent; border:none; justify-content:center; }
		.menu a { position:relative; text-decoration:none; color:#ffffff; padding:15px 20px; display:inline-block; line-height:1; transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size:18px; font-weight:600; border-radius:12px; text-transform:uppercase; letter-spacing:0.5px; }
		.menu a::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius:12px; opacity:0; transition:opacity 0.3s ease; }
		.menu a::after { content:""; position:absolute; left:50%; right:50%; bottom:-8px; height:3px; background: linear-gradient(90deg, #ffffff, #ffebee); transform: translateX(-50%) scaleX(0); transform-origin:center; transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius:2px; width:0; }
		.menu a:hover { color:#ffffff; transform: translateY(-2px); text-shadow: 0 2px 4px rgba(0,0,0,0.2);} 

		/* Page spacing to replace previous body margin */
		.page-content { padding: 20px; }

		/* Candidate profile (red header) */
		.candidate-profile { 
			background: #d32f2f; /* red */
			color: #ffffff; 
			padding: 16px; 
			border-radius: 6px; 
			display: flex; 
			align-items: center; 
			justify-content: space-between; 
			margin-bottom: 20px; 
		}
		.candidate-info { 
			display: flex; 
			flex-direction: column; 
			gap: 4px; 
		}
		.candidate-name { font-size: 18px; font-weight: bold; }
		.candidate-position { opacity: 0.9; }
		.vote-btn { 
			background: #ffffff; 
			color: #d32f2f; 
			border-radius: 4px; 
			border: 1px solid #ffffff; 
			padding: 10px 16px; 
			font-weight: 600; 
		}
		.vote-btn:hover { 
			background: #ffe5e5; 
			color: #b71c1c; 
		}
    </style>
</head>
<body>
	<header class="topbar" role="banner">
		<nav class="nav" aria-label="Main navigation">
			<div class="navbar-logo">
				<img src="pictures/UM-TAGUM (1).png" alt="UM-TAGUM College Logo" class="navbar-logo-img">
				<span class="brand-title">Vote Na GA!</span>
			</div>
			<ul class="menu" role="menubar">
				<li role="none"><a role="menuitem" href="Dasboard for Student or user/index.html">Home</a></li>
				<li role="none"><a role="menuitem" href="Dasboard for Student or user/candidates.html">Candidates</a></li>
				<li role="none"><a role="menuitem" href="Voting Status/voting_status_working.html">Voting Status</a></li>
				<li role="none"><a role="menuitem" href="Dasboard for Student or user/index.html#results">Leading Candidate</a></li>
				<li role="none"><a role="menuitem" href="Account/account.html">Account</a></li>
			</ul>
		</nav>
	</header>

	<div class="page-content">
		<h1>Test Vote Confirmation Fix</h1>

	<!-- Red candidate profile at the top -->
	<div id="candidateProfile" class="candidate-profile">
		<div class="candidate-info">
			<div id="cpName" class="candidate-name">Loading candidate...</div>
			<div id="cpPosition" class="candidate-position"></div>
		</div>
		<div>
			<button id="cpVoteBtn" class="vote-btn" disabled>Vote</button>
		</div>
	</div>

	<div id="topVoteResult" class="result" style="display:none;"></div>
    
    <div class="test-section">
        <h3>Test 1: Check Current Voting Status</h3>
        <button onclick="checkVotingStatus()">Check Voting Status</button>
        <div id="statusResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: Simulate Vote Button Click (Should Check Status First)</h3>
        <button onclick="simulateVoteClick()">Simulate Vote Click</button>
        <div id="voteClickResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: Reset Votes (For Testing)</h3>
        <button onclick="resetVotes()">Reset All Votes</button>
        <div id="resetResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 4: Submit a Vote and Check Status Again</h3>
        <button onclick="submitVoteAndCheck()">Submit Vote & Check Status</button>
        <div id="submitResult" class="result"></div>
    </div>
    
    <script>
        const API_BASE = 'config/simple_api_v2.php';
        const STUDENT_ID = 1;
        let availableCandidates = [];

		async function loadTopCandidate() {
			const nameEl = document.getElementById('cpName');
			const posEl = document.getElementById('cpPosition');
			const voteBtn = document.getElementById('cpVoteBtn');
			const topResult = document.getElementById('topVoteResult');

			nameEl.textContent = 'Loading candidate...';
			posEl.textContent = '';
			voteBtn.disabled = true;
			voteBtn.onclick = null;

			try {
				const response = await fetch(`${API_BASE}?action=get_candidates`);
				const data = await response.json();

				if (!data.success || !data.data) {
					nameEl.textContent = 'No candidates available';
					return;
				}

				let firstCandidate = null;
				let firstPosition = null;
				for (const [position, candidates] of Object.entries(data.data)) {
					if (candidates.length > 0) {
						firstCandidate = candidates[0];
						firstPosition = position;
						break;
					}
				}

				if (!firstCandidate) {
					nameEl.textContent = 'No candidates available';
					return;
				}

				nameEl.textContent = `${firstCandidate.first_name} ${firstCandidate.last_name}`;
				posEl.textContent = `${firstPosition}`;
				voteBtn.disabled = false;
				voteBtn.onclick = async () => {
					await voteForCandidate(firstCandidate.candidate_id, firstPosition);
				};
			} catch (err) {
				nameEl.textContent = 'Error loading candidate';
			}
		}

		async function voteForCandidate(candidateId, position) {
			const topResult = document.getElementById('topVoteResult');
			topResult.style.display = 'block';
			topResult.className = 'result';
			topResult.textContent = 'Submitting your vote...';

			try {
				const voteResponse = await fetch(API_BASE, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						action: 'submit_vote',
						student_id: STUDENT_ID,
						candidate_id: candidateId,
						position: position
					})
				});

				const voteData = await voteResponse.json();
				if (voteData.success) {
					topResult.className = 'result success';
					topResult.textContent = '✓ Vote submitted successfully!';
					// Refresh status display
					checkVotingStatus();
				} else {
					topResult.className = 'result error';
					topResult.textContent = '✗ Vote failed: ' + voteData.message;
				}
			} catch (error) {
				topResult.className = 'result error';
				topResult.textContent = '✗ Error: ' + error.message;
			}
		}
        
        async function checkVotingStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = 'Checking voting status...';
            
            try {
                const response = await fetch(`${API_BASE}?action=get_student_votes&student_id=${STUDENT_ID}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    let html = '✓ Voting status retrieved successfully<br><br>';
                    
                    if (data.votes.length === 0) {
                        html += '<strong>Status: No votes found</strong><br>';
                        html += 'This means the student can vote for any position.';
                    } else {
                        html += '<strong>Status: Student has voted for:</strong><br>';
                        data.votes.forEach(vote => {
                            html += `- ${vote.position}: ${vote.first_name} ${vote.last_name}<br>`;
                        });
                        html += '<br><strong>This means the student should NOT see confirmation dialogs for these positions.</strong>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '✗ Error: ' + data.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '✗ Error: ' + error.message;
            }
        }
        
        async function simulateVoteClick() {
            const resultDiv = document.getElementById('voteClickResult');
            resultDiv.innerHTML = 'Simulating vote button click...';
            
            try {
                // First check if student has voted for any position
                const statusResponse = await fetch(`${API_BASE}?action=get_student_votes&student_id=${STUDENT_ID}`);
                const statusData = await statusResponse.json();
                
                let hasVotedForAnyPosition = false;
                let votedPositions = [];
                if (statusData.success && statusData.votes) {
                    hasVotedForAnyPosition = statusData.votes.length > 0;
                    votedPositions = statusData.votes.map(v => v.position);
                }
                
                if (hasVotedForAnyPosition) {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `✓ CORRECT: Student has already voted for: ${votedPositions.join(', ')}. The system should show "You have already voted for this position" instead of confirmation dialog for these positions.`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✓ CORRECT: Student has not voted for any position yet. The system should show confirmation dialog when voting.';
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '✗ Error: ' + error.message;
            }
        }
        
        async function resetVotes() {
            const resultDiv = document.getElementById('resetResult');
            resultDiv.innerHTML = 'Resetting votes...';
            
            try {
                const response = await fetch('reset_votes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'confirm=yes'
                });
                
                const text = await response.text();
                
                if (text.includes('Successfully deleted')) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✓ Votes reset successfully. Student can now vote again.';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '✗ Error resetting votes: ' + text;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '✗ Error: ' + error.message;
            }
        }
        
        async function submitVoteAndCheck() {
            const resultDiv = document.getElementById('submitResult');
            resultDiv.innerHTML = 'Submitting vote and checking status...';
            
            try {
                // First get available candidates
                const candidatesResponse = await fetch(`${API_BASE}?action=get_candidates`);
                const candidatesData = await candidatesResponse.json();
                
                if (!candidatesData.success || !candidatesData.data) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '✗ Error: Could not get candidates list';
                    return;
                }
                
                // Find first available candidate
                let firstCandidate = null;
                let firstPosition = null;
                
                for (const [position, candidates] of Object.entries(candidatesData.data)) {
                    if (candidates.length > 0) {
                        firstCandidate = candidates[0];
                        firstPosition = position;
                        break;
                    }
                }
                
                if (!firstCandidate) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '✗ Error: No candidates available';
                    return;
                }
                
                resultDiv.innerHTML = `Submitting vote for ${firstCandidate.first_name} ${firstCandidate.last_name} for ${firstPosition}...`;
                
                // Submit a vote
                const voteResponse = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submit_vote',
                        student_id: STUDENT_ID,
                        candidate_id: firstCandidate.candidate_id,
                        position: firstPosition
                    })
                });
                
                const voteData = await voteResponse.json();
                
                if (voteData.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '✓ Vote submitted successfully!<br>Now checking status again...';
                    
                    // Check status again
                    setTimeout(async () => {
                        const statusResponse = await fetch(`${API_BASE}?action=get_student_votes&student_id=${STUDENT_ID}`);
                        const statusData = await statusResponse.json();
                        
                        if (statusData.success && statusData.votes) {
                            const positionVote = statusData.votes.find(v => v.position === firstPosition);
                            if (positionVote) {
                                resultDiv.innerHTML += `<br><br>✓ Status updated: Student voted for ${positionVote.first_name} ${positionVote.last_name} for ${firstPosition}`;
                                resultDiv.innerHTML += '<br><strong>Now if the student tries to vote again, they should see "You have already voted for this position" instead of confirmation dialog.</strong>';
                            }
                        }
                    }, 1000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = '✗ Vote failed: ' + voteData.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '✗ Error: ' + error.message;
            }
        }
        
		// Auto-run
		window.onload = function() {
			checkVotingStatus();
			loadTopCandidate();
		};
    </script>
</body>
</html>
